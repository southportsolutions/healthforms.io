
name: Library - Build and Deploy

on:
  workflow_dispatch:
      inputs:
        logLevel:
          description: 'Log level'
          required: true
          default: 'warning'
          type: choice
          options:
          - info
          - warning
          - debug
        tags:
          description: 'Test scenario tags'
          required: false
          type: boolean
        environment:
          description: 'Environment to run tests against'
          type: environment
          required: true
  push:
    branches: [ main ]
    tags: [ 'release-core@*' ]

env:
  PROJECT_PATH: ${{vars.PROJECT_PATH}}
  BUILD_CONFIGURATION: ${{vars.BUILD_CONFIGURATION}}
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'
        
      - name: Derive PROJECT_NAME (keep PROJECT_PATH unchanged)
        id: project-name
        shell: bash
        run: |
          # use the existing PROJECT_PATH env var (do not overwrite it)
          path="${PROJECT_PATH:-}"
          path="${path%/}"                  # drop trailing slash if any
          last="${path##*/}"                # last path segment
          if [[ "${last,,}" == *.csproj ]]; then
            PROJECT_NAME="${last%.csproj}"  # strip extension if present
          else
            PROJECT_NAME="$last"
          fi
          echo "Derived PROJECT_NAME=$PROJECT_NAME"
          echo "PROJECT_NAME=$PROJECT_NAME" >> "$GITHUB_ENV"

      - name: Resolve version
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/release@* ]]; then
            # tag is like refs/tags/release@1.2.3
            VERSION="${GITHUB_REF#refs/tags/release@}"
          else
            VERSION="1.0.0-alpha1"
          fi
          echo "Derived VERSION=$VERSION"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
      
      - name: Turn on globstar and nullglob
        shell: bash
        run: |
          shopt -s globstar nullglob

      - name: Restore
        run: dotnet restore ./${{ env.PROJECT_PATH }}.csproj --configfile nuget.config

      - name: Build & Pack
        run: |
          dotnet pack ./${{ env.PROJECT_PATH }}.csproj \
            --output "${{ github.workspace }}/artifacts" \
            --configuration "${{ env.BUILD_CONFIGURATION }}" \
            /p:Version="${{ steps.version.outputs.version }}"

      - name: Publish to nuget.org (only on release tags)
        if: startsWith(github.ref, 'refs/tags/release@')
        env:
          NUGET_API_KEY: ${{ secrets.NUGETPUSH }}
          SOURCE: 'https://api.nuget.org/v3/index.json'
        run: dotnet nuget push **/${{ steps.project-name.outputs.project-name }}.${{ steps.version.outputs.version }}.nupkg --source ${SOURCE} --api-key ${NUGET_API_KEY}
